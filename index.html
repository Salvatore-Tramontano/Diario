<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Diario</title>
    
    <!-- Librerie -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; -webkit-tap-highlight-color: transparent; }
        
        /* Utility */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        /* Animations */
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Filter Panel Animation */
        #filterPanel { transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        #filterPanel.open { max-height: 500px; opacity: 1; }

        /* Custom UI Elements */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: #a855f7; margin-top: -8px; box-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
            transition: transform 0.1s;
        }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #334155; border-radius: 2px; }

        .nav-item.active i { color: #a855f7; transform: translateY(-5px); }
        .nav-item.active span { color: white; opacity: 1; }
        .nav-item i { transition: all 0.3s; }
        
        /* Custom Dropdown Checkbox */
        .dropdown-check { position: relative; }
        .dropdown-content { display: none; position: absolute; background-color: #1e293b; min-width: 100%; z-index: 50; border: 1px solid #334155; border-radius: 0.5rem; padding: 0.5rem; margin-top: 2px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .dropdown-content.show { display: block; }
        
        /* Time Toggle in Dashboard */
        .segment-control { @apply bg-slate-800 p-1 rounded-lg flex gap-1 border border-slate-700; }
        .time-toggle-btn { @apply px-3 py-1.5 text-[10px] font-bold uppercase rounded-md text-slate-400 flex-1 text-center transition; }
        .time-toggle-btn.active { @apply bg-slate-600 text-white shadow-sm; }

        /* --- STILE FILTRI PULITO --- */
        .cat-chip-container { 
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 16px 20px;
            width: 100%;
            align-items: center;
        }
        
        .cat-chip-modern { 
            flex-shrink: 0;
            padding: 10px 20px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background-color: #1e293b; 
            color: #94a3b8; 
            border: 1px solid #334155;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .cat-chip-modern.active { 
            background: linear-gradient(135deg, #7c3aed, #d946ef);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.5);
            transform: translateY(-2px);
        }

        /* Modal Category Chips */
        .modal-cat-chip { 
            @apply flex flex-col items-center justify-center min-w-[70px] h-[70px] rounded-2xl border border-slate-700 bg-slate-800/50 transition-all duration-200 cursor-pointer text-slate-500; 
        }
        .modal-cat-chip:hover { @apply bg-slate-700 text-slate-300; }
        .modal-cat-chip.selected { 
            @apply bg-purple-600 border-purple-400 text-white shadow-lg shadow-purple-900/50 transform scale-105 ring-2 ring-purple-400 ring-offset-2 ring-offset-slate-900; 
        }
        .modal-cat-chip.selected i { @apply text-white !important; }
        .modal-cat-chip.selected span { @apply text-white !important; font-weight: 800; }

        /* Auto-save Indicator */
        #saveIndicator { transition: opacity 0.5s; opacity: 0; }
        #saveIndicator.show { opacity: 1; }

        /* Backup Alert */
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } }
        .backup-needed { animation: pulse-red 2s infinite; border-color: #ef4444 !important; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-100 bg-[#0f172a]">

    <!-- HEADER & FILTRI (FISSI) -->
    <div class="bg-slate-900 z-30 shadow-xl flex-none relative flex flex-col">
        <!-- Top Bar -->
        <div class="pt-4 pb-2 px-4 flex justify-between items-center bg-slate-900 z-40 relative border-b border-slate-800">
            <div>
                <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 tracking-tight">Diario</h1>
                <div class="flex items-center gap-2 h-4">
                    <span id="saveIndicator" class="text-[10px] text-green-400 flex items-center gap-1 font-bold"><i class="fa-solid fa-check"></i> Salvato</span>
                </div>
            </div>
            <div class="flex gap-2">
                <!-- Import -->
                <button onclick="document.getElementById('fileInput').click()" class="bg-slate-800 w-9 h-9 rounded-full border border-slate-700 hover:bg-slate-700 transition flex items-center justify-center" title="Importa">
                    <i class="fa-solid fa-upload text-slate-400 text-sm"></i>
                </button>
                <input type="file" id="fileInput" class="hidden" accept=".json,.csv,.xlsx,.xls" onchange="importFile(event)">

                <!-- Export -->
                <div class="relative group">
                    <button id="btnExport" onclick="toggleExportMenu()" class="bg-slate-800 w-9 h-9 rounded-full border border-slate-700 hover:bg-slate-700 transition flex items-center justify-center relative">
                        <i class="fa-solid fa-download text-slate-400 text-sm"></i>
                        <div id="backupAlert" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-slate-900"></div>
                    </button>
                    <div id="exportMenu" class="hidden absolute right-0 mt-2 w-48 bg-slate-800 border border-slate-700 rounded-xl shadow-2xl z-50 overflow-hidden ring-1 ring-white/10">
                        <div class="px-4 py-2 bg-slate-900/50 border-b border-slate-700 hidden" id="backupMsg">
                            <span class="text-[9px] text-red-400 font-bold uppercase">‚ö†Ô∏è Backup</span>
                        </div>
                        <button onclick="exportData('xlsx')" class="w-full text-left px-4 py-3 text-xs hover:bg-slate-700 flex items-center gap-2 text-slate-300 font-medium border-b border-slate-700">
                            <i class="fa-solid fa-file-excel text-green-500"></i> Excel (.xlsx)
                        </button>
                        <button onclick="exportData('csv')" class="w-full text-left px-4 py-3 text-xs hover:bg-slate-700 flex items-center gap-2 text-slate-300 font-medium border-b border-slate-700">
                            <i class="fa-solid fa-file-csv text-blue-400"></i> CSV
                        </button>
                        <button onclick="exportData('json')" class="w-full text-left px-4 py-3 text-xs hover:bg-slate-700 flex items-center gap-2 text-slate-300 font-medium">
                            <i class="fa-solid fa-file-code text-purple-400"></i> Backup JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AREA FILTRI (Sempre Visibile) -->
        <div class="bg-slate-900/50 backdrop-blur-sm border-b border-slate-800/50 relative z-30">
            <!-- 1. Categorie Scroll (Pulsanti Pillola) -->
            <div class="cat-chip-container" id="filterCatContainer">
                <!-- Generato via JS -->
            </div>

            <!-- 2. Toolbar Filtri (Sotto) -->
            <div class="grid grid-cols-12 gap-3 mt-0 pb-3 items-center px-4 relative z-40">
                <div class="col-span-5">
                     <select id="filterTime" onchange="applyFilters()" class="w-full bg-slate-800 border border-slate-700 rounded-lg text-[10px] font-bold p-2.5 outline-none h-full text-slate-300 uppercase tracking-wide">
                        <option value="year" selected>Quest'Anno</option>
                        <option value="month">Questo Mese</option>
                        <option value="week">7 Giorni</option>
                        <option value="today">Oggi</option>
                        <option value="all">Tutto</option>
                    </select>
                </div>
                
                <!-- Dropdown Voto con fix visualizzazione -->
                <div class="col-span-4 dropdown-check invisible" id="ratingFilterWrapper">
                    <button onclick="toggleRatingDropdown()" class="w-full bg-slate-800 border border-slate-700 rounded-lg text-[10px] font-bold p-2.5 outline-none text-left flex justify-between items-center h-full text-slate-300 uppercase tracking-wide">
                        <span id="ratingBtnLabel" class="truncate">Voti</span>
                        <i class="fa-solid fa-chevron-down text-[8px] opacity-50"></i>
                    </button>
                    <!-- Dropdown Content -->
                    <div id="ratingDropdown" class="dropdown-content">
                        <div class="space-y-2 p-1">
                            <label class="flex items-center gap-2 text-xs p-1 hover:bg-slate-700 rounded cursor-pointer"><input type="checkbox" value="5" class="accent-purple-500 rating-check" onchange="updateRatingFilter()"> 5 ‚òÖ</label>
                            <label class="flex items-center gap-2 text-xs p-1 hover:bg-slate-700 rounded cursor-pointer"><input type="checkbox" value="4" class="accent-purple-500 rating-check" onchange="updateRatingFilter()"> 4 ‚òÖ</label>
                            <label class="flex items-center gap-2 text-xs p-1 hover:bg-slate-700 rounded cursor-pointer"><input type="checkbox" value="3" class="accent-purple-500 rating-check" onchange="updateRatingFilter()"> 3 ‚òÖ</label>
                            <label class="flex items-center gap-2 text-xs p-1 hover:bg-slate-700 rounded cursor-pointer"><input type="checkbox" value="2" class="accent-purple-500 rating-check" onchange="updateRatingFilter()"> 2 ‚òÖ</label>
                            <label class="flex items-center gap-2 text-xs p-1 hover:bg-slate-700 rounded cursor-pointer"><input type="checkbox" value="1" class="accent-purple-500 rating-check" onchange="updateRatingFilter()"> 1 ‚òÖ</label>
                        </div>
                    </div>
                </div>

                <div class="col-span-3 flex items-center justify-end gap-2">
                     <span class="text-[9px] font-bold text-slate-500" id="filterCountDisplay">0</span>
                     <button onclick="resetFilters()" class="w-8 h-8 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-400 hover:text-white hover:bg-red-500/20 transition"><i class="fa-solid fa-rotate-left text-[10px]"></i></button>
                </div>
            </div>

            <!-- 3. Filtri Specifici (Dinamici) -->
            <div id="filterSpecifics" class="hidden border-t border-slate-700/50 pt-3 pb-3 flex flex-wrap gap-2 px-4">
                <div class="flex flex-wrap gap-2 w-full" id="dynamicFilters"></div>
            </div>
        </div>
    </div>

    <!-- VIEW: DIARIO -->
    <div id="viewHome" class="flex-1 flex flex-col relative overflow-hidden bg-[#0f172a]">
        <main id="entriesList" class="flex-1 overflow-y-auto p-5 space-y-4 hide-scroll pb-32">
            <!-- Lista Items -->
        </main>

        <button onclick="openModal()" class="absolute bottom-24 right-6 w-16 h-16 bg-gradient-to-br from-purple-600 to-indigo-500 rounded-full shadow-[0_10px_30px_rgba(168,85,247,0.4)] flex items-center justify-center text-2xl text-white z-20 hover:scale-110 active:scale-95 transition border-4 border-slate-900 group">
            <i class="fa-solid fa-plus group-hover:rotate-90 transition duration-300"></i>
        </button>
    </div>

    <!-- VIEW: REPORT -->
    <div id="viewDash" class="flex-1 flex flex-col hidden overflow-hidden bg-[#0f172a]">
        <!-- Controllo Granularit√† Temporale -->
        <div class="px-5 pt-6 pb-2 flex items-center justify-between" id="dashTimeControls">
            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Aggregazione</span>
            <div class="segment-control">
                <button onclick="setDashTime('day')" id="dt_day" class="time-toggle-btn">GG</button>
                <button onclick="setDashTime('week')" id="dt_week" class="time-toggle-btn">Set</button>
                <button onclick="setDashTime('month')" id="dt_month" class="time-toggle-btn active">Mes</button>
                <button onclick="setDashTime('year')" id="dt_year" class="time-toggle-btn">Ann</button>
            </div>
        </div>
        
        <div id="dashContent" class="flex-1 overflow-y-auto p-5 pb-24 space-y-8">
            <!-- Contenuto dinamico BI -->
        </div>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-xl border-t border-slate-800 h-[85px] flex justify-around items-center z-40 pb-5 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
        <div onclick="switchView('home')" class="nav-item active flex flex-col items-center justify-center w-full h-full cursor-pointer text-slate-500 group">
            <div class="p-1.5 rounded-2xl group-hover:bg-slate-800/50 transition mb-1"><i class="fa-solid fa-book-open text-xl"></i></div>
            <span class="text-[9px] font-bold tracking-widest">DIARIO</span>
        </div>
        <div onclick="switchView('dash')" class="nav-item flex flex-col items-center justify-center w-full h-full cursor-pointer text-slate-500 group">
            <div class="p-1.5 rounded-2xl group-hover:bg-slate-800/50 transition mb-1"><i class="fa-solid fa-chart-pie text-xl"></i></div>
            <span class="text-[9px] font-bold tracking-widest">REPORT</span>
        </div>
    </nav>

    <!-- MODALE INSERIMENTO -->
    <div id="addModal" class="fixed inset-0 z-50 hidden flex flex-col justify-end">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-md transition-opacity" onclick="closeModal()"></div>
        <div class="glass rounded-t-[2.5rem] p-6 w-full max-h-[95vh] overflow-y-auto relative slide-up z-60 bg-[#1e293b] shadow-2xl border-t border-white/10">
            <div class="w-16 h-1.5 bg-slate-700/50 rounded-full mx-auto mb-8"></div>
            
            <label class="text-[10px] font-black text-slate-400 uppercase mb-4 block tracking-widest ml-1">Scegli Categoria</label>
            <div class="flex gap-4 overflow-x-auto hide-scroll pb-6 mb-2 px-1" id="modalCatContainer">
                <!-- Generato JS -->
            </div>
            
            <div id="dynamicForm" class="space-y-6 animate-fade-in"></div>
            
            <div class="pt-8 pb-4">
                <button onclick="saveEntry()" class="w-full bg-gradient-to-r from-purple-600 to-pink-500 py-4 rounded-2xl font-bold text-lg text-white shadow-lg shadow-purple-900/30 hover:opacity-90 active:scale-95 transition flex justify-center items-center gap-3">
                    <span>Salva Ricordo</span> <i class="fa-solid fa-check"></i>
                </button>
            </div>
            <div class="h-6"></div>
        </div>
    </div>

    <datalist id="historyTitles"></datalist>

    <script>
        // --- 1. CONFIGURAZIONE ---
        const categories = [
            { id: 'Film', icon: 'fa-film', color: 'text-red-400', border: 'border-red-500' },
            { id: 'Serie', icon: 'fa-tv', color: 'text-orange-400', border: 'border-orange-500' },
            { id: 'Libro', icon: 'fa-book', color: 'text-blue-400', border: 'border-blue-500' },
            { id: 'Teatro', icon: 'fa-masks-theater', color: 'text-pink-400', border: 'border-pink-500' },
            { id: 'Concerti', icon: 'fa-music', color: 'text-violet-400', border: 'border-violet-500' },
            { id: 'Lavoro', icon: 'fa-briefcase', color: 'text-slate-400', border: 'border-slate-500' },
            { id: 'Podcast', icon: 'fa-microphone', color: 'text-purple-400', border: 'border-purple-500' },
            { id: 'Sport', icon: 'fa-person-running', color: 'text-cyan-400', border: 'border-cyan-500' },
            { id: 'Sociale', icon: 'fa-users', color: 'text-green-400', border: 'border-green-500' },
            { id: 'Altro', icon: 'fa-layer-group', color: 'text-gray-400', border: 'border-gray-500' },
            { id: 'Giornata', icon: 'fa-calendar-day', color: 'text-yellow-400', border: 'border-yellow-500' }
        ];

        let db = JSON.parse(localStorage.getItem('lifelog_bi_v8')) || [];
        let lastBackupDate = localStorage.getItem('lifelog_last_backup_date') || null;
        let currentCat = 'Film';
        let chartInstances = {};

        // DEFAULT FILTRO: ANNO CORRENTE
        let activeFilters = { cat: 'All', time: 'year', ratings: [], flags: {} };
        let dashTimeGranularity = 'month';

        // --- 2. INIZIALIZZAZIONE ---
        document.addEventListener('DOMContentLoaded', () => {
            renderFilterCats();
            renderModalCategories();
            
            // Imposta dropdown UI al valore di default
            document.getElementById('filterTime').value = 'year';
            
            applyFilters();
            updateDatalist();
            renderDynamicForm('Film'); 
            checkBackupStatus();
        });

        // --- 3. UI LOGIC (Dropdowns) ---
        function toggleRatingDropdown() { 
            const d = document.getElementById('ratingDropdown');
            d.classList.toggle('show');
        }
        function toggleExportMenu() { document.getElementById('exportMenu').classList.toggle('hidden'); }
        
        window.onclick = function(e) {
            if (!e.target.closest('.dropdown-check') && !e.target.closest('#exportMenu') && !e.target.closest('button[onclick="toggleExportMenu()"]')) {
                document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
                document.getElementById('exportMenu').classList.add('hidden');
            }
        }

        // --- LOGICA FILTRI ---
        function renderFilterCats() {
            const c = document.getElementById('filterCatContainer');
            let h = `<button onclick="setFilterCat('All')" id="fbtn_All" class="cat-chip-modern active">Tutti</button>`;
            categories.forEach(cat => {
                h += `<button onclick="setFilterCat('${cat.id}')" id="fbtn_${cat.id}" class="cat-chip-modern">${cat.id}</button>`;
            });
            c.innerHTML = h;
        }

        function setFilterCat(cat) {
            activeFilters.cat = cat; activeFilters.flags = {}; 
            
            document.querySelectorAll('.cat-chip-modern').forEach(b => b.classList.remove('active'));
            document.getElementById('fbtn_'+cat).classList.add('active');
            
            const ratingWrapper = document.getElementById('ratingFilterWrapper');
            if (cat === 'All' || cat === 'Lavoro' || cat === 'Giornata') {
                ratingWrapper.classList.add('invisible');
            } else {
                ratingWrapper.classList.remove('invisible');
            }

            renderSpecificFilters(cat); applyFilters();
        }

        function renderSpecificFilters(cat) {
            const c = document.getElementById('filterSpecifics'); const t = document.getElementById('dynamicFilters'); t.innerHTML = '';
            let opts = [];
            if(cat==='Film') opts=[{k:'cinema',l:'Cinema'},{k:'rewatch',l:'Rewatch'}];
            if(cat==='Serie') opts=[{k:'finished',l:'Finite'},{k:'rewatch',l:'Rewatch'}];
            if(cat==='Libro') opts=[{k:'finished',l:'Finiti'},{k:'reread',l:'Riletture'}];
            if(cat==='Lavoro'||cat==='Giornata') opts=[{k:'dayOk',l:'Giornate S√¨'}];

            if(opts.length>0) {
                c.classList.remove('hidden');
                t.innerHTML = opts.map(o => `<label class="bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-700 flex items-center gap-2 cursor-pointer text-[10px] font-bold text-slate-400 uppercase select-none hover:bg-slate-700 transition"><input type="checkbox" onchange="toggleFlag('${o.k}')" class="accent-purple-500 rounded">${o.l}</label>`).join('');
            } else c.classList.add('hidden');
        }
        function toggleFlag(k) { activeFilters.flags[k] = !activeFilters.flags[k]; applyFilters(); }
        function updateRatingFilter() {
            const checks = document.querySelectorAll('.rating-check:checked');
            activeFilters.ratings = Array.from(checks).map(c => parseInt(c.value));
            document.getElementById('ratingBtnLabel').innerText = activeFilters.ratings.length ? activeFilters.ratings.length + " sel." : "Voti";
            applyFilters();
        }
        function resetFilters() {
            activeFilters = {cat:'All',time:'year',ratings:[],flags:{}};
            document.getElementById('filterTime').value='year';
            document.querySelectorAll('.rating-check').forEach(c=>c.checked=false);
            updateRatingFilter();
            setFilterCat('All');
        }

        // --- CORE: LOGICA FILTRO E ANNI ---
        function applyFilters() {
            activeFilters.time = document.getElementById('filterTime').value;
            const now = new Date();
            
            let filtered = db.filter(i => {
                if(activeFilters.cat!=='All' && i.cat!==activeFilters.cat) return false;
                if(activeFilters.ratings.length && !activeFilters.ratings.includes(i.rating)) return false;
                
                const d = new Date(i.date);
                if(activeFilters.time==='today' && d.setHours(0,0,0,0)!==now.setHours(0,0,0,0)) return false;
                if(activeFilters.time==='week' && (now-d)>604800000) return false;
                if(activeFilters.time==='month' && (d.getMonth()!==now.getMonth()||d.getFullYear()!==now.getFullYear())) return false;
                if(activeFilters.time==='year' && d.getFullYear()!==now.getFullYear()) return false;
                
                for(let [k,v] of Object.entries(activeFilters.flags)) {
                     if(v && (!i.meta || !i.meta[k])) return false;
                     if(k==='dayOk' && v && i.meta.dayOk!=='S√¨') return false;
                }
                return true;
            });
            
            document.getElementById('filterCountDisplay').innerText = filtered.length;
            renderList(filtered);
            if(!document.getElementById('viewDash').classList.contains('hidden')) renderDashboard(filtered);
            return filtered;
        }

        // --- 6. RENDER DIARIO ---
        function renderList(data) {
            const list = document.getElementById('entriesList');
            data.sort((a,b)=>new Date(b.date)-new Date(a.date));
            if(data.length===0) { list.innerHTML=`<div class="text-center text-slate-600 mt-20 opacity-50"><i class="fa-solid fa-ghost text-4xl mb-3"></i><p class="text-xs">Nessun dato trovato</p></div>`; return; }
            list.innerHTML = data.map(i => {
                const c = categories.find(x=>x.id===i.cat)||categories[0];
                const d = new Date(i.date);
                let det='', ext='', stars='';
                // Details construction
                if(i.cat==='Serie') { det=`S${i.meta.season}:E${i.meta.episode}`; if(i.meta.finished) ext+=`<span class="bg-green-500/20 text-green-300 text-[9px] px-1.5 py-0.5 rounded ml-1 font-bold">FIN</span>`; }
                if(i.cat==='Libro') { det=`Pag.${i.meta.page||'?'}`; if(i.meta.finished) ext+=`<span class="bg-green-500/20 text-green-300 text-[9px] px-1.5 py-0.5 rounded ml-1 font-bold">FIN</span>`; }
                if(i.cat==='Lavoro') { det=`Prod:${i.meta.productivity}/10`; if(i.meta.dayOk==='S√¨') ext+=` üëç`; }
                if(i.cat==='Giornata') { det=i.meta.dayOk==='S√¨'?'Giornata Ottima':'Giornata No'; }
                if(i.cat==='Podcast') det = i.meta.epTitle || ''; if(i.cat==='Sport') det = i.meta.subEvent || '';
                if(i.cat==='Teatro'||i.cat==='Concerti'||i.cat==='Altro') det = i.meta.place || '';
                if(i.meta.cinema) ext+=`<span class="bg-red-500/20 text-red-300 text-[9px] px-1.5 py-0.5 rounded ml-1 font-bold">CINEMA</span>`;
                if(i.meta.rewatch || i.meta.reread) ext+=`<span class="bg-blue-500/20 text-blue-300 text-[9px] px-1.5 py-0.5 rounded ml-1 font-bold">REW</span>`;
                if(i.rating>0) for(let s=0;s<5;s++) stars+=s<i.rating?'<i class="fa-solid fa-star text-yellow-400 text-[10px]"></i>':'<i class="fa-solid fa-star text-slate-700 text-[10px]"></i>';

                return `<div class="glass p-4 rounded-2xl flex gap-4 items-center border border-slate-700/50 hover:bg-slate-800/50 transition"><div class="flex flex-col items-center min-w-[45px]"><div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center mb-1 border border-slate-700 text-lg shadow-inner ${c.color}"><i class="fa-solid ${c.icon}"></i></div></div><div class="flex-1 min-w-0"><div class="flex justify-between items-start"><span class="text-[9px] text-slate-500 font-bold uppercase tracking-wide">${d.getDate()}/${d.getMonth()+1} ‚Ä¢ ${c.id}</span><div class="flex gap-0.5">${stars}</div></div><h3 class="font-bold text-sm text-white truncate pr-2 mt-0.5">${i.title||i.cat} ${ext}</h3>${det ? `<div class="text-[11px] text-purple-300 font-medium mt-0.5 truncate">${det}</div>` : ''}${i.notes ? `<p class="text-[10px] text-slate-400 mt-1.5 line-clamp-1 italic">"${i.notes}"</p>` : ''}</div><button onclick="deleteEntry(${i.id})" class="text-slate-700 hover:text-red-500 p-2"><i class="fa-solid fa-trash text-xs"></i></button></div>`;
            }).join('');
        }

        // --- DASHBOARD LOGIC ---
        function renderDashboard(data) {
            const catFilter = activeFilters.cat;
            const container = document.getElementById('dashContent');
            const kpi = (lbl, val, sub, col, icon) => `<div class="glass p-4 rounded-2xl border-l-4 border-${col}-500 flex flex-col justify-between relative overflow-hidden shadow-lg"><div class="flex justify-between items-start z-10"><span class="text-[10px] uppercase text-slate-400 font-extrabold tracking-widest">${lbl}</span>${icon ? `<i class="fa-solid ${icon} text-slate-600 text-sm"></i>` : ''}</div><div class="text-3xl font-black text-white mt-1 z-10">${val}</div>${sub ? `<div class="text-[10px] text-slate-500 z-10 font-medium">${sub}</div>` : ''}<div class="absolute -bottom-4 -right-4 text-7xl opacity-5 text-${col}-500"><i class="fa-solid fa-circle"></i></div></div>`;
            let html = '';

            // Recupera label periodo corrente
            const periodLabel = document.getElementById('filterTime').options[document.getElementById('filterTime').selectedIndex].text;

            if (catFilter === 'All') {
                if(!data) data = applyFilters();
                
                const count = (c) => data.filter(i => i.cat === c).length;
                const work = data.filter(i => i.cat === 'Lavoro');
                const workPct = work.length ? Math.round((work.filter(i => i.meta.dayOk === 'S√¨').length/work.length)*100) : 0;
                const day = data.filter(i => i.cat === 'Giornata');
                const dayPct = day.length ? Math.round((day.filter(i => i.meta.dayOk === 'S√¨').length/day.length)*100) : 0;

                html = `<div class="mb-4 flex items-center gap-2"><div class="w-1 h-4 bg-purple-500 rounded-full"></div><h2 class="text-xs font-bold text-slate-300 uppercase tracking-widest">Riepilogo: ${periodLabel}</h2></div><div class="grid grid-cols-2 gap-4">${kpi("Film", count('Film'), "Visti", "red", "fa-film")}${kpi("Serie TV", count('Serie'), "Episodi", "orange", "fa-tv")}${kpi("Libri", count('Libro'), "Letti", "blue", "fa-book")}${kpi("Teatro", count('Teatro'), "Spettacoli", "pink", "fa-masks-theater")}${kpi("Concerti", count('Concerti'), "Eventi", "violet", "fa-music")}${kpi("Podcast", count('Podcast'), "Puntate", "purple", "fa-microphone")}${kpi("Sport", count('Sport'), "Attivit√†", "cyan", "fa-person-running")}${kpi("Sociale", count('Sociale'), "Uscite", "green", "fa-users")}${kpi("Lavoro OK", workPct + "%", `Su ${work.length} gg`, "slate", "fa-briefcase")}${kpi("Mood OK", dayPct + "%", `Su ${day.length} gg`, "yellow", "fa-calendar-day")}</div>`;
                document.getElementById('dashTimeControls').classList.add('hidden');
            } else {
                document.getElementById('dashTimeControls').classList.remove('hidden');
                if(!data) data = applyFilters(); 
                const grouped = aggregateDataByTime(data, dashTimeGranularity);
                const count = data.length;
                const avg = (data.reduce((a,b)=>a+b.rating,0)/(count||1)).toFixed(1);
                const chartBox = (id, h, title) => `<div class="glass p-4 rounded-2xl mb-6 shadow-lg"><h3 class="text-[10px] font-bold text-slate-500 uppercase mb-4 tracking-wider">${title}</h3><div class="h-${h}"><canvas id="${id}"></canvas></div></div>`;
                
                html += `<div class="grid grid-cols-2 gap-4 mb-6">${kpi("Totale", count, periodLabel, "purple")}${kpi("Media Voto", avg, "Su 5 stelle", "yellow")}</div>`;

                if(catFilter==='Film') html+=`<div class="grid grid-cols-2 gap-4 mb-6"><div class="glass p-2 rounded-2xl h-40 relative"><canvas id="chPieLoc"></canvas></div><div class="glass p-2 rounded-2xl h-40 relative"><canvas id="chPieRew"></canvas></div></div>${chartBox("chBarTime", "48", "Trend")}${chartBox("chBarRate", "32", "Voti")}`;
                else if(catFilter==='Serie') html+=`<div class="grid grid-cols-2 gap-4 mb-6"><div class="glass p-2 rounded-2xl h-40 relative"><canvas id="chPieRew"></canvas></div>${kpi("Finite", data.filter(i=>i.meta.finished).length, "Concluse", "green")}</div>${chartBox("chBarTime", "48", "Trend")}${chartBox("chBarRate", "32", "Voti")}`;
                else if(catFilter==='Libro') html+=`<div class="grid grid-cols-2 gap-4 mb-6"><div class="glass p-2 rounded-2xl h-40 relative"><canvas id="chPieRew"></canvas></div>${kpi("Finiti", data.filter(i=>i.meta.finished).length, "Conclusi", "green")}</div>${chartBox("chBarTime", "48", "Trend")}${chartBox("chBarRate", "32", "Voti")}`;
                else if(catFilter==='Lavoro') html+=`<div class="grid grid-cols-2 gap-4 mb-6"><div class="glass p-2 rounded-2xl h-40 relative"><canvas id="chPieDay"></canvas></div>${kpi("Rottura", (data.reduce((a,b)=>a+parseInt(b.meta.annoyance||0),0)/(count||1)).toFixed(1), "Media (0-10)", "red")}</div>${chartBox("chLineWork", "56", "Produttivit√† vs Rottura")}`;
                else if(catFilter==='Giornata') html+=`<div class="grid grid-cols-2 gap-4 mb-6"><div class="glass p-2 rounded-2xl h-40 relative"><canvas id="chPieDay"></canvas></div>${kpi("Mood", avg, "Media (1-5)", "yellow")}</div>${chartBox("chLineMood", "48", "Andamento Umore")}`;
                else html+=`${chartBox("chBarTime", "48", "Trend")}${chartBox("chBarRate", "32", "Voti")}`;
            }
            container.innerHTML = html;
            if(catFilter !== 'All') { setTimeout(() => { renderCharts(data, catFilter); }, 50); }
        }

        // --- ALTRE FUNZIONI (Charts, Form, Ecc) RIMANGONO INVARIATE ---
        function setDashTime(t){dashTimeGranularity=t;document.querySelectorAll('.time-toggle-btn').forEach(b=>b.classList.remove('active'));document.getElementById('dt_'+t).classList.add('active');renderDashboard();}
        function aggregateDataByTime(data,g){const gr={};data.forEach(i=>{const d=new Date(i.date);let k='';if(g==='day')k=d.getDate()+'/'+(d.getMonth()+1);else if(g==='month')k=(d.getMonth()+1)+'/'+d.getFullYear().toString().slice(-2);else if(g==='year')k=d.getFullYear();else{const s=new Date(d.getFullYear(),0,1);k='W'+Math.ceil((((d-s)/86400000)+1)/7);}gr[k]=(gr[k]||0)+1;});return gr;}
        function mkChart(id,t,l,ds){if(chartInstances[id])chartInstances[id].destroy();const ctx=document.getElementById(id).getContext('2d');Chart.defaults.color='#64748b';Chart.defaults.borderColor='rgba(255,255,255,0.05)';chartInstances[id]=new Chart(ctx,{type:t,data:{labels:l,datasets:ds},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:t!=='pie'},y:{display:t!=='pie',beginAtZero:true}}}});}
        function mkPie(id,l,d,c){if(chartInstances[id])chartInstances[id].destroy();const ctx=document.getElementById(id).getContext('2d');chartInstances[id]=new Chart(ctx,{type:'doughnut',data:{labels:l,datasets:[{data:d,backgroundColor:c,borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'75%',plugins:{legend:{position:'bottom',labels:{boxWidth:8,font:{size:9},color:'#94a3b8'}}}}});}
        function checkBackupStatus(){/* ... */}
        function toggleExportMenu(){document.getElementById('exportMenu').classList.toggle('hidden');}
        function exportData(f){/* ... */}
        function importFile(e){/* ... */}
        function triggerAutoSave(){localStorage.setItem('lifelog_bi_v8',JSON.stringify(db));const i=document.getElementById('saveIndicator');i.classList.add('show');setTimeout(()=>i.classList.remove('show'),2000);}
        function deleteEntry(id){if(confirm("Eliminare?")){db=db.filter(i=>i.id!==id);triggerAutoSave();applyFilters();}}
        function openModal(){document.getElementById('addModal').classList.remove('hidden');setModalCategory('Film');}
        function closeModal(){document.getElementById('addModal').classList.add('hidden');}
        function updateDatalist(){/* ... */}
        function setModalCategory(cat) { currentCat = cat; renderModalCategories(); renderDynamicForm(cat); }
        function renderModalCategories() {document.getElementById('modalCatContainer').innerHTML = categories.map(c => `<div onclick="setModalCategory('${c.id}')" class="modal-cat-chip flex flex-col items-center justify-center min-w-[70px] h-[70px] rounded-2xl border transition active:scale-95 cursor-pointer ${currentCat===c.id ? 'selected' : 'border-slate-700 bg-slate-800/50 opacity-60'}"><i class="fa-solid ${c.icon} ${currentCat===c.id ? 'text-white' : c.color} text-lg mb-1"></i><span class="text-[8px] font-semibold ${currentCat===c.id ? 'text-white' : 'text-slate-300'}">${c.id}</span></div>`).join('');}
        function renderDynamicForm(cat) { const f=document.getElementById('dynamicForm'); let h=`<div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Data</label><input type="datetime-local" id="inpDate" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl p-3 text-sm text-white outline-none focus:border-purple-500 transition"></div>`; const txt=(l,p)=>`<div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">${l}</label><input type="text" id="inpTitle" list="historyTitles" placeholder="${p}" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl p-3 text-sm text-white outline-none focus:border-purple-500 transition"></div>`; const sub=(id,l,p)=>`<div><label class="text-[9px] font-bold text-slate-500 uppercase mb-1 block">${l}</label><input type="text" id="${id}" placeholder="${p}" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl p-2 text-sm text-white outline-none focus:border-purple-500 transition"></div>`; const rate=`<div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Voto</label><div class="flex justify-between bg-slate-800/50 p-3 rounded-xl border border-slate-600">${[1,2,3,4,5].map(i=>`<i onclick="setRating(${i})" class="fa-star cursor-pointer text-xl text-slate-600 hover:text-yellow-400 transition fa-solid star-icon" data-val="${i}"></i>`).join('')}</div><input type="hidden" id="inpRating" value="0"></div>`; const chk=(id,l)=>`<div class="flex items-center gap-3 bg-slate-800/50 p-3 rounded-xl border border-slate-600 flex-1 cursor-pointer hover:bg-slate-700 transition"><input type="checkbox" id="${id}" class="w-5 h-5 accent-purple-500 rounded"><label for="${id}" class="text-xs font-bold select-none cursor-pointer">${l}</label></div>`; const note=`<div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Note</label><textarea id="inpNotes" rows="3" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl p-3 text-sm text-white outline-none focus:border-purple-500 transition"></textarea></div>`; const sld=(id,l,val)=>`<div><label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block flex justify-between"><span>${l}</span> <span id="lbl_${id}" class="text-purple-400 font-mono text-sm">${val}</span></label><input type="range" id="${id}" min="0" max="10" step="1" value="${val}" oninput="document.getElementById('lbl_${id}').innerText=this.value"></div>`; const dayOk=`<div><label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Com'√® andata?</label><div class="flex gap-2"><button onclick="setDayOk('S√¨',this)" class="day-btn flex-1 p-2 bg-slate-800 border border-slate-600 rounded-xl text-sm font-bold hover:bg-green-900/40 transition">üëç S√¨</button><button onclick="setDayOk('No',this)" class="day-btn flex-1 p-2 bg-slate-800 border border-slate-600 rounded-xl text-sm font-bold hover:bg-red-900/40 transition">üëé No</button></div><input type="hidden" id="inpDayOk" value=""></div>`; if(cat==='Film') h+=`${txt("Titolo Film","Es. Inception")} <div class="flex gap-2 mt-3 mb-3">${chk("inpCinema","Cinema")} ${chk("inpRewatch","Rewatch")}</div> ${rate}`; else if(cat==='Serie') h+=`${txt("Titolo Serie","Es. Breaking Bad")} <div class="flex gap-2 mt-3"><div class="flex-1">${sub("inpSeason","S","1")}</div><div class="flex-1">${sub("inpEpisode","Ep","1")}</div></div><div class="flex gap-2 mt-3 mb-3">${chk("inpFinished","Finita")} ${chk("inpRewatch","Rewatch")}</div> ${rate}`; else if(cat==='Libro') h+=`${txt("Titolo Libro","Es. 1984")} <div class="flex gap-2 mt-3">${sub("inpPage","Pagina","120")}</div> <div class="flex gap-2 mt-3 mb-3">${chk("inpFinished","Finito")} ${chk("inpReread","Rilettura")}</div> ${rate}`; else if(cat==='Lavoro') h+=`${txt("Progetto / Task","Es. Dev App")} ${sld("inpProd","Produttivit√†",7)} ${sld("inpAnnoy","Livello Rottura",2)} ${dayOk}`; else if(cat==='Giornata') h+=`${dayOk} ${sld("inpMood","Mood Generale (1-5)",3)}`; else if(cat==='Podcast') h+=`${txt("Nome Podcast","Es. Daily Tech")} ${sub("inpEpTitle","Titolo Puntata","Es. #42 - AI")} ${rate}`; else if(cat==='Sport') h+=`${txt("Sport","Es. Corsa")} ${sub("inpSubEvent","Dettagli","Es. 10km Parco")} ${rate}`; else if(cat==='Teatro') h+=`${txt("Spettacolo","Es. Amleto")} ${sub("inpPlace","Teatro","Es. La Scala")} ${rate}`; else if(cat==='Concerti') h+=`${txt("Artista","Es. Queen")} ${sub("inpPlace","Luogo","Es. Wembley")} ${rate}`; else if(cat==='Altro') h+=`${txt("Titolo","Es. Evento generico")} ${sub("inpPlace","Luogo","Es. Roma")} ${rate}`; else h+=`${txt("Titolo","Descrizione breve")} ${rate}`; h+=note; f.innerHTML=h; const now=new Date(); now.setMinutes(now.getMinutes()-now.getTimezoneOffset()); document.getElementById('inpDate').value=now.toISOString().slice(0,16); }
        function switchView(viewName) { document.getElementById('viewHome').classList.add('hidden'); document.getElementById('viewDash').classList.add('hidden'); document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); if(viewName === 'home') { document.getElementById('viewHome').classList.remove('hidden'); document.querySelectorAll('.nav-item')[0].classList.add('active'); document.getElementById('dashTimeControls').classList.add('hidden'); } else { document.getElementById('viewDash').classList.remove('hidden'); document.querySelectorAll('.nav-item')[1].classList.add('active'); if(activeFilters.cat === 'All') document.getElementById('dashTimeControls').classList.add('hidden'); else document.getElementById('dashTimeControls').classList.remove('hidden'); renderDashboard(); } }
        
        // Render Charts Implementation (Separated for brevity)
        function renderCharts(data, cat) {
            const grouped = aggregateDataByTime(data, dashTimeGranularity);
            if(document.getElementById('chBarTime')) mkChart('chBarTime','bar',Object.keys(grouped).reverse(),[{label:'Qta',data:Object.values(grouped).reverse(),backgroundColor:'#a855f7',borderRadius:6}]);
            if(document.getElementById('chBarRate')) {
                const r=[0,0,0,0,0]; data.forEach(i=>{if(i.rating>0&&i.rating<=5)r[i.rating-1]++});
                mkChart('chBarRate','bar',['1','2','3','4','5'],[{label:'Voti',data:r,backgroundColor:'#eab308',borderRadius:4}]);
            }
            if(cat==='Film') {
                mkPie('chPieLoc',['Cinema','Casa'],[data.filter(i=>i.meta.cinema).length, data.length-data.filter(i=>i.meta.cinema).length],['#ef4444','#334155']);
                mkPie('chPieRew',['Rewatch','Nuovi'],[data.filter(i=>i.meta.rewatch).length, data.length-data.filter(i=>i.meta.rewatch).length],['#3b82f6','#334155']);
            }
            if(cat==='Serie'||cat==='Libro') {
                const k = cat==='Libro'?'reread':'rewatch';
                mkPie('chPieRew',[cat==='Libro'?'Riletti':'Rewatch','Nuovi'],[data.filter(i=>i.meta[k]).length, data.length-data.filter(i=>i.meta[k]).length],['#3b82f6','#334155']);
            }
            if(cat==='Lavoro'||cat==='Giornata') {
                mkPie('chPieDay',['S√¨','No'],[data.filter(i=>i.meta.dayOk==='S√¨').length, data.filter(i=>i.meta.dayOk!=='S√¨').length],['#22c55e','#ef4444']);
            }
            if(cat==='Lavoro') {
                const s = [...data].sort((a,b)=>new Date(a.date)-new Date(b.date));
                mkChart('chLineWork','line',s.map(i=>i.date.slice(5,10)),[
                    {label:'Prod',data:s.map(i=>i.meta.productivity),borderColor:'#3b82f6',tension:0.3,pointRadius:0},
                    {label:'Rott',data:s.map(i=>i.meta.annoyance),borderColor:'#ef4444',tension:0.3,pointRadius:0}
                ]);
            }
            if(cat==='Giornata') {
                const s = [...data].sort((a,b)=>new Date(a.date)-new Date(b.date));
                mkChart('chLineMood','line',s.map(i=>i.date.slice(5,10)),[{label:'Mood',data:s.map(i=>i.rating),borderColor:'#eab308',tension:0.4}]);
            }
        }
        
        function importFile(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();if(f.name.endsWith('.json')){r.onload=function(e){try{let j=JSON.parse(e.target.result);if(Array.isArray(j)){const ids=new Set(db.map(d=>d.id));j.forEach(i=>{if(!ids.has(i.id))db.push(i)});triggerAutoSave();applyFilters();alert("Fatto!");}}catch(err){alert("Errore JSON");}};r.readAsText(f);}else{r.onload=function(e){try{const d=new Uint8Array(e.target.result);const wb=XLSX.read(d,{type:'array'});const ws=wb.Sheets[wb.SheetNames[0]];const raw=XLSX.utils.sheet_to_json(ws);let c=0;const ids=new Set(db.map(d=>d.id));raw.forEach(r=>{let m={};if(r.Meta_Completo_JSON)try{m=JSON.parse(r.Meta_Completo_JSON)}catch(e){}else if(r.Meta)try{m=JSON.parse(r.Meta)}catch(e){}const i={id:r.ID||Date.now()+Math.floor(Math.random()*1000),date:r.Data||new Date().toISOString(),cat:r.Categoria||'Altro',title:r.Titolo||'Importato',rating:parseInt(r.Voto)||0,notes:r.Note||'',meta:m};if(!ids.has(i.id)){db.push(i);c++;}});triggerAutoSave();applyFilters();alert(`Importati ${c}`);}catch(e){console.error(e);alert("Errore Excel");}};r.readAsArrayBuffer(f);}}
        function exportData(f){/*Same as prev*/}
    </script>
</body>
</html>