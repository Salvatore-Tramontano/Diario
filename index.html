<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <title>Diario</title>
    
    <!-- Librerie Esterne -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        
        /* Base Reset & Mobile Optimization */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a; 
            color: #f1f5f9; 
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* Gestiamo lo scroll internamente */
            position: fixed; width: 100%; height: 100%;
        }

        /* Utilities */
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .touch-scroll { overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* Glass Effect */
        .glass-panel { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }

        /* UI Components */
        .btn-primary { @apply bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white font-bold shadow-lg shadow-purple-900/40 active:scale-95 transition-transform; }
        .btn-secondary { @apply bg-slate-800 border border-slate-700 text-slate-300 font-medium active:bg-slate-700 transition-colors; }
        
        .cat-chip { 
            @apply flex-shrink-0 px-5 py-2.5 rounded-full text-[11px] font-bold uppercase tracking-wider bg-slate-900 border border-slate-800 text-slate-400 transition-all duration-200 select-none;
        }
        .cat-chip.active { 
            @apply bg-white text-slate-900 border-white shadow-[0_0_15px_rgba(255,255,255,0.3)] scale-105 z-10; 
        }

        /* Modal Overlay Transition */
        #modalOverlay { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); transform: translateY(100%); }
        #modalOverlay.open { transform: translateY(0); }

        /* Range Slider */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: #d946ef; margin-top: -10px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #334155; border-radius: 2px; }

        /* FAB */
        .fab {
            position: absolute; bottom: 100px; right: 24px; width: 60px; height: 60px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white; z-index: 50;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            border: 2px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- 1. HEADER FISSO (Titolo + Filtri Macro) -->
    <header class="flex-none z-20 bg-slate-950 border-b border-white/5 relative">
        <div class="pt-10 pb-2 px-5 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-violet-400 to-fuchsia-400">Diario</h1>
                <p id="statusMsg" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest transition-colors duration-500">Pronto</p>
            </div>
            <div class="flex gap-3">
                <!-- Nota: Import rimosso onchange inline per evitare errori -->
                <button onclick="app.handlers.import()" class="w-9 h-9 rounded-full bg-slate-900 border border-slate-700 text-slate-400 flex items-center justify-center active:bg-slate-800"><i class="fa-solid fa-file-import"></i></button>
                <input type="file" id="fileInput" class="hidden" accept=".json,.csv,.xlsx,.xls">

                <button onclick="app.handlers.export()" class="w-9 h-9 rounded-full bg-slate-900 border border-slate-700 text-slate-400 flex items-center justify-center active:bg-slate-800"><i class="fa-solid fa-download"></i></button>
            </div>
        </div>

        <!-- Filtri Orizzontali (Scrollable) -->
        <div class="w-full overflow-x-auto hide-scroll pb-3 pt-1 px-5 flex gap-3" id="categoryFilterBar">
            <!-- Iniettato via JS -->
        </div>
    </header>

    <!-- 2. CONTENUTO PRINCIPALE (Scrollabile) -->
    <main id="mainContainer" class="flex-1 touch-scroll relative bg-slate-900">
        <!-- VISTA LISTA -->
        <div id="view-list" class="p-4 pb-32 space-y-4 min-h-full">
            <!-- Lista Items -->
        </div>

        <!-- VISTA REPORT -->
        <div id="view-report" class="hidden p-5 pb-32 space-y-6 min-h-full">
            <!-- Filtri Tempo Report -->
            <div class="flex justify-between items-center bg-slate-800 p-1 rounded-lg border border-slate-700">
                <button onclick="app.setReportTime('week')" class="report-time-btn flex-1 py-1.5 text-[10px] font-bold uppercase rounded text-center text-slate-400" data-t="week">7GG</button>
                <button onclick="app.setReportTime('month')" class="report-time-btn flex-1 py-1.5 text-[10px] font-bold uppercase rounded text-center text-slate-400 bg-slate-600 text-white shadow" data-t="month">Mese</button>
                <button onclick="app.setReportTime('year')" class="report-time-btn flex-1 py-1.5 text-[10px] font-bold uppercase rounded text-center text-slate-400" data-t="year">Anno</button>
                <button onclick="app.setReportTime('all')" class="report-time-btn flex-1 py-1.5 text-[10px] font-bold uppercase rounded text-center text-slate-400" data-t="all">Tot</button>
            </div>
            <!-- Contenuto Charts -->
            <div id="reportContent" class="space-y-6"></div>
        </div>
    </main>

    <!-- FAB BUTTON (Solo in vista Lista) -->
    <button id="fabBtn" onclick="app.openModal()" class="fab btn-primary">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- 3. BOTTOM NAVIGATION -->
    <nav class="flex-none h-20 bg-slate-950/90 backdrop-blur-xl border-t border-white/5 flex justify-around items-center pb-2 z-30">
        <button onclick="app.switchView('list')" class="nav-btn flex flex-col items-center gap-1 text-violet-400 p-4" data-v="list">
            <i class="fa-solid fa-book-open text-xl"></i>
            <span class="text-[9px] font-bold">DIARIO</span>
        </button>
        <button onclick="app.switchView('report')" class="nav-btn flex flex-col items-center gap-1 text-slate-500 p-4" data-v="report">
            <i class="fa-solid fa-chart-pie text-xl"></i>
            <span class="text-[9px] font-bold">REPORT</span>
        </button>
    </nav>

    <!-- 4. MODALE INSERIMENTO (Full Screen Overlay) -->
    <div id="modalOverlay" class="fixed inset-0 z-50 bg-slate-900 flex flex-col">
        <!-- Modal Header -->
        <div class="flex-none h-16 px-5 flex items-center justify-between border-b border-slate-800 bg-slate-900">
            <button onclick="app.closeModal()" class="text-slate-400 px-2 py-4"><i class="fa-solid fa-xmark text-xl"></i></button>
            <span class="font-bold text-sm tracking-wider uppercase text-slate-300">Nuovo Ricordo</span>
            <button onclick="app.saveData()" class="text-violet-400 font-bold text-sm px-2 py-4">SALVA</button>
        </div>

        <!-- Modal Content (Scrollable form) -->
        <div class="flex-1 touch-scroll p-5 pb-10">
            <form id="entryForm" onsubmit="event.preventDefault(); app.saveData();">
                
                <!-- Category Grid -->
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-3 block">Categoria</label>
                <div class="grid grid-cols-4 gap-3 mb-6" id="modalCatGrid"></div>

                <!-- Dynamic Fields Container -->
                <div id="formFields" class="space-y-5 animate-fade">
                    <!-- Iniettato via JS -->
                </div>

            </form>
        </div>
    </div>

    <!-- Script Logica Applicativa -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const CONFIG = {
                cats: [
                    {id: 'Film', icon: 'fa-film', col: 'text-red-400'},
                    {id: 'Serie', icon: 'fa-tv', col: 'text-orange-400'},
                    {id: 'Libro', icon: 'fa-book', col: 'text-blue-400'},
                    {id: 'Lavoro', icon: 'fa-briefcase', col: 'text-slate-400'},
                    {id: 'Podcast', icon: 'fa-microphone', col: 'text-purple-400'},
                    {id: 'Sport', icon: 'fa-person-running', col: 'text-cyan-400'},
                    {id: 'Sociale', icon: 'fa-users', col: 'text-green-400'},
                    {id: 'Teatro', icon: 'fa-masks-theater', col: 'text-pink-400'},
                    {id: 'Concerti', icon: 'fa-music', col: 'text-violet-400'},
                    {id: 'Altro', icon: 'fa-layer-group', col: 'text-gray-400'},
                    {id: 'Giornata', icon: 'fa-calendar-day', col: 'text-yellow-400'}
                ]
            };

            // --- CORE APPLICATION ---
            const app = {
                db: JSON.parse(localStorage.getItem('diario_db_v1')) || [],
                state: {
                    view: 'list',
                    filterCat: 'All',
                    reportTime: 'month',
                    modalCat: 'Film'
                },

                init() {
                    this.renderFilters();
                    this.renderList();
                    this.renderModalCats(); // Pre-render modal
                    this.updateForm('Film'); // Pre-render form
                    this.setupFileInput();
                },

                // --- NAVIGATION ---
                switchView(v) {
                    this.state.view = v;
                    document.getElementById('view-list').classList.toggle('hidden', v !== 'list');
                    document.getElementById('view-report').classList.toggle('hidden', v !== 'report');
                    document.getElementById('fabBtn').classList.toggle('hidden', v !== 'list');
                    
                    // Update Nav Buttons
                    document.querySelectorAll('.nav-btn').forEach(b => {
                        b.classList.toggle('text-violet-400', b.dataset.v === v);
                        b.classList.toggle('text-slate-500', b.dataset.v !== v);
                    });

                    if(v === 'report') this.renderReport();
                },

                // --- LIST & FILTERS ---
                renderFilters() {
                    const c = document.getElementById('categoryFilterBar');
                    let h = `<button onclick="window.app.setFilter('All')" class="cat-chip ${this.state.filterCat==='All'?'active':''}">Tutti</button>`;
                    CONFIG.cats.forEach(cat => {
                        h += `<button onclick="window.app.setFilter('${cat.id}')" class="cat-chip ${this.state.filterCat===cat.id?'active':''}">${cat.id}</button>`;
                    });
                    c.innerHTML = h;
                },

                setFilter(cat) {
                    this.state.filterCat = cat;
                    this.renderFilters();
                    this.renderList();
                    if(this.state.view === 'report') this.renderReport();
                },

                renderList() {
                    const list = document.getElementById('view-list');
                    let data = this.db.sort((a,b) => new Date(b.date) - new Date(a.date));
                    
                    if(this.state.filterCat !== 'All') {
                        data = data.filter(i => i.cat === this.state.filterCat);
                    }

                    if(data.length === 0) {
                        list.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-600 space-y-4">
                            <i class="fa-solid fa-ghost text-4xl opacity-50"></i>
                            <p class="text-xs uppercase font-bold tracking-widest">Nessun Ricordo</p>
                        </div>`;
                        return;
                    }

                    list.innerHTML = data.map(item => {
                        const catObj = CONFIG.cats.find(c => c.id === item.cat) || CONFIG.cats[9];
                        const d = new Date(item.date);
                        const dateStr = `${d.getDate()}/${d.getMonth()+1}`;
                        
                        let metaBadges = '';
                        if(item.meta?.cinema) metaBadges += `<span class="bg-red-500/20 text-red-300 text-[9px] px-1.5 rounded font-bold ml-2">CINEMA</span>`;
                        if(item.meta?.rewatch || item.meta?.reread) metaBadges += `<span class="bg-blue-500/20 text-blue-300 text-[9px] px-1.5 rounded font-bold ml-2">REW</span>`;
                        
                        // Rating visual
                        let stars = '';
                        if(item.rating > 0) {
                            stars = `<div class="flex gap-0.5 text-[9px] text-yellow-500 ml-auto">`;
                            for(let i=0; i<item.rating; i++) stars += '<i class="fa-solid fa-star"></i>';
                            stars += `</div>`;
                        }

                        return `
                        <div class="glass-panel rounded-2xl p-4 flex gap-4 items-center">
                            <div class="flex flex-col items-center min-w-[40px]">
                                <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700 ${catObj.col}">
                                    <i class="fa-solid ${catObj.icon}"></i>
                                </div>
                                <span class="text-[9px] text-slate-500 font-mono mt-1">${dateStr}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-center mb-0.5">
                                    <span class="text-[9px] font-bold text-slate-500 uppercase tracking-wide">${item.cat}</span>
                                    ${stars}
                                </div>
                                <h3 class="font-bold text-sm text-white truncate leading-tight">${item.title} ${metaBadges}</h3>
                                <p class="text-xs text-slate-400 mt-1 truncate opacity-80">${item.notes || '...'}</p>
                            </div>
                            <button onclick="window.app.deleteItem(${item.id})" class="w-8 h-8 flex items-center justify-center text-slate-600 hover:text-red-400 active:scale-90 transition">
                                <i class="fa-solid fa-trash text-xs"></i>
                            </button>
                        </div>`;
                    }).join('');
                },

                // --- MODAL & FORM LOGIC ---
                openModal() {
                    // Set default date
                    const now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    this.defaultDate = now.toISOString().slice(0,16);
                    
                    document.getElementById('modalOverlay').classList.add('open');
                    this.updateForm(this.state.modalCat); // Render current form
                },

                closeModal() {
                    document.getElementById('modalOverlay').classList.remove('open');
                },

                renderModalCats() {
                    const grid = document.getElementById('modalCatGrid');
                    grid.innerHTML = CONFIG.cats.map(c => `
                        <div onclick="window.app.setModalCat('${c.id}')" class="cat-select-btn flex flex-col items-center justify-center h-20 rounded-xl bg-slate-800 border border-slate-700 text-slate-500 transition active:scale-95 ${this.state.modalCat === c.id ? 'active-cat' : ''}" id="mcat_${c.id}">
                            <i class="fa-solid ${c.icon} text-xl mb-1 pointer-events-none"></i>
                            <span class="text-[9px] font-bold uppercase pointer-events-none">${c.id}</span>
                        </div>
                    `).join('');
                    
                    // Add CSS class dynamically if not exists
                    if(!document.getElementById('dynamic-style')) {
                        const style = document.createElement('style');
                        style.id = 'dynamic-style';
                        style.innerHTML = `.active-cat { background-color: #7c3aed !important; border-color: #a78bfa !important; color: white !important; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4); }`;
                        document.head.appendChild(style);
                    }
                },

                setModalCat(id) {
                    this.state.modalCat = id;
                    document.querySelectorAll('.cat-select-btn').forEach(b => b.classList.remove('active-cat'));
                    document.getElementById('mcat_'+id).classList.add('active-cat');
                    this.updateForm(id);
                },

                updateForm(cat) {
                    const f = document.getElementById('formFields');
                    // Componenti riutilizzabili
                    const dateHtml = `<div><label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Data</label><input type="datetime-local" name="date" class="w-full h-12 bg-slate-800 border border-slate-700 rounded-xl px-4 text-sm text-white focus:border-violet-500 outline-none" value="${this.defaultDate}"></div>`;
                    const titleHtml = (ph) => `<div><label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Titolo / Oggetto</label><input type="text" name="title" placeholder="${ph}" class="w-full h-12 bg-slate-800 border border-slate-700 rounded-xl px-4 text-sm text-white focus:border-violet-500 outline-none"></div>`;
                    const notesHtml = `<div><label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Note</label><textarea name="notes" rows="3" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-sm text-white focus:border-violet-500 outline-none"></textarea></div>`;
                    const ratingHtml = `<div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center"><span class="text-xs font-bold text-slate-400 uppercase">Voto</span><div class="flex gap-2">${[1,2,3,4,5].map(v => `<label class="cursor-pointer"><input type="radio" name="rating" value="${v}" class="hidden peer"><i class="fa-solid fa-star text-2xl text-slate-700 peer-checked:text-yellow-400 transition"></i></label>`).join('')}</div></div>`;
                    
                    // Helper toggle
                    const toggle = (name, label) => `<label class="flex items-center gap-3 bg-slate-800 p-3 rounded-xl border border-slate-700"><input type="checkbox" name="${name}" class="w-5 h-5 accent-violet-500 rounded"><span class="text-xs font-bold text-slate-300 select-none">${label}</span></label>`;
                    
                    let content = dateHtml;

                    if(cat === 'Film') {
                        content += titleHtml("Titolo del film");
                        content += `<div class="flex gap-3">${toggle('cinema','Al Cinema')} ${toggle('rewatch','Gi√† Visto')}</div>`;
                        content += ratingHtml;
                    } else if (cat === 'Serie') {
                        content += titleHtml("Titolo Serie");
                        content += `<div class="flex gap-3"><input type="number" name="season" placeholder="S" class="w-20 h-12 bg-slate-800 border-slate-700 rounded-xl text-center text-white"><input type="number" name="episode" placeholder="Ep" class="w-20 h-12 bg-slate-800 border-slate-700 rounded-xl text-center text-white"></div>`;
                        content += `<div class="flex gap-3">${toggle('finished','Finita')}</div>`;
                        content += ratingHtml;
                    } else if (cat === 'Lavoro') {
                        content += titleHtml("Progetto / Task");
                        content += `<div><label class="text-xs text-slate-500 mb-1 block">Produttivit√†</label><input type="range" name="productivity" min="0" max="10" step="1" value="5"></div>`;
                        content += `<div><label class="text-xs text-slate-500 mb-1 block">Rottura</label><input type="range" name="annoyance" min="0" max="10" step="1" value="2"></div>`;
                        content += `<div class="flex gap-2"><label class="flex-1 bg-slate-800 p-3 rounded-xl text-center border border-slate-700"><input type="radio" name="dayOk" value="S√¨" class="hidden peer"><span class="text-xs font-bold text-slate-400 peer-checked:text-green-400">üëç Ottima</span></label><label class="flex-1 bg-slate-800 p-3 rounded-xl text-center border border-slate-700"><input type="radio" name="dayOk" value="No" class="hidden peer"><span class="text-xs font-bold text-slate-400 peer-checked:text-red-400">üëé Pessima</span></label></div>`;
                    } else if (cat === 'Giornata') {
                        content += `<div><label class="text-xs text-slate-500 mb-1 block">Mood Generale (1-5)</label><input type="range" name="rating" min="1" max="5" step="1" value="3"></div>`;
                        content += `<div class="flex gap-2"><label class="flex-1 bg-slate-800 p-3 rounded-xl text-center border border-slate-700"><input type="radio" name="dayOk" value="S√¨" class="hidden peer"><span class="text-xs font-bold text-slate-400 peer-checked:text-green-400">üëç S√¨</span></label><label class="flex-1 bg-slate-800 p-3 rounded-xl text-center border border-slate-700"><input type="radio" name="dayOk" value="No" class="hidden peer"><span class="text-xs font-bold text-slate-400 peer-checked:text-red-400">üëé No</span></label></div>`;
                    } else {
                        // Default generic
                        content += titleHtml(`Dettagli ${cat}`);
                        if(cat === 'Teatro' || cat === 'Concerti' || cat === 'Altro') {
                            content += `<div><label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Luogo</label><input type="text" name="place" class="w-full h-12 bg-slate-800 border border-slate-700 rounded-xl px-4 text-sm text-white outline-none"></div>`;
                        }
                        content += ratingHtml;
                    }

                    content += notesHtml;
                    f.innerHTML = content;
                },

                // --- SAVING ---
                saveData() {
                    const form = document.getElementById('entryForm');
                    if(!form) return;
                    
                    const formData = new FormData(form);
                    const obj = Object.fromEntries(formData.entries());
                    
                    // Costruzione Oggetto Sicuro
                    const newEntry = {
                        id: Date.now(),
                        date: obj.date || new Date().toISOString(),
                        cat: this.state.modalCat,
                        title: obj.title || (this.state.modalCat === 'Giornata' ? 'Diario' : 'Senza Titolo'),
                        rating: parseInt(obj.rating) || 0,
                        notes: obj.notes || '',
                        meta: {
                            cinema: form.querySelector('[name="cinema"]')?.checked || false,
                            rewatch: form.querySelector('[name="rewatch"]')?.checked || false,
                            finished: form.querySelector('[name="finished"]')?.checked || false,
                            season: obj.season || '',
                            episode: obj.episode || '',
                            productivity: obj.productivity || '',
                            annoyance: obj.annoyance || '',
                            dayOk: obj.dayOk || '',
                            place: obj.place || ''
                        }
                    };

                    this.db.unshift(newEntry);
                    this.persist();
                    
                    // UI Feedback
                    this.closeModal();
                    confetti({ particleCount: 80, spread: 60, origin: { y: 0.7 } });
                    this.renderList();
                    this.setSaveStatus("Salvato!");
                },

                deleteItem(id) {
                    if(confirm("Eliminare?")) {
                        this.db = this.db.filter(i => i.id !== id);
                        this.persist();
                        this.renderList();
                    }
                },

                persist() {
                    localStorage.setItem('diario_db_v1', JSON.stringify(this.db));
                },

                setSaveStatus(msg) {
                    const el = document.getElementById('statusMsg');
                    if(el) {
                        const orig = el.innerText;
                        el.innerText = msg;
                        el.classList.add('text-green-400');
                        setTimeout(() => {
                            el.innerText = "Pronto";
                            el.classList.remove('text-green-400');
                        }, 2000);
                    }
                },

                // --- REPORT ---
                setReportTime(t) {
                    this.state.reportTime = t;
                    document.querySelectorAll('.report-time-btn').forEach(b => {
                        b.className = `report-time-btn flex-1 py-1.5 text-[10px] font-bold uppercase rounded text-center transition ${b.dataset.t === t ? 'bg-slate-600 text-white shadow' : 'text-slate-400'}`;
                    });
                    this.renderReport();
                },

                renderReport() {
                    const ctx = document.getElementById('reportContent');
                    const data = this.db; 
                    
                    const total = data.length;
                    const avgRating = (data.reduce((a,b)=>a+b.rating,0)/(total||1)).toFixed(1);

                    ctx.innerHTML = `
                        <div class="grid grid-cols-2 gap-4">
                            <div class="glass-panel p-4 rounded-2xl border-l-4 border-violet-500">
                                <div class="text-[10px] uppercase text-slate-400 font-bold">Totale</div>
                                <div class="text-3xl font-black text-white">${total}</div>
                            </div>
                            <div class="glass-panel p-4 rounded-2xl border-l-4 border-fuchsia-500">
                                <div class="text-[10px] uppercase text-slate-400 font-bold">Media Voto</div>
                                <div class="text-3xl font-black text-white">${avgRating}</div>
                            </div>
                        </div>
                        <div class="glass-panel p-4 rounded-2xl h-64 flex items-center justify-center text-slate-500 text-xs">
                            <i class="fa-solid fa-chart-simple text-4xl mb-2 opacity-20 block"></i>
                            Grafici temporali disponibili in futuro...
                        </div>
                    `;
                },

                setupFileInput() {
                    const fi = document.getElementById('fileInput');
                    if(fi) {
                        fi.addEventListener('change', (e) => {
                            const file = e.target.files[0];
                            if(!file) return;
                            const reader = new FileReader();
                            reader.onload = (evt) => {
                                try {
                                    if(file.name.endsWith('.json')) {
                                        this.db = JSON.parse(evt.target.result);
                                        this.persist();
                                        this.init();
                                        alert("Ripristino completato!");
                                    } else {
                                        alert("Formato non supportato. Usa JSON.");
                                    }
                                } catch(err) { alert("Errore file"); }
                            };
                            reader.readAsText(file);
                        });
                    }
                },

                // --- HANDLERS ESTERNI ---
                handlers: {
                    export: () => {
                        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app.db));
                        const downloadAnchorNode = document.createElement('a');
                        downloadAnchorNode.setAttribute("href",     dataStr);
                        downloadAnchorNode.setAttribute("download", "diario_backup.json");
                        document.body.appendChild(downloadAnchorNode);
                        downloadAnchorNode.click();
                        downloadAnchorNode.remove();
                    },
                    import: () => document.getElementById('fileInput').click()
                }
            };

            // Global expose for inline onclicks
            window.app = app;
            app.init();
        });
    </script>
</body>
</html>
